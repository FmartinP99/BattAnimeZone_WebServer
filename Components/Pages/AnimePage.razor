@inject NavigationManager navManager
@using BattAnimeZone.Components.Models.Anime
@using BattAnimeZone.Services
@inject AnimeService animeService
@page "/anime/{mal_id:int}"
<link rel="stylesheet" href="/AnimePage.css" />

@if (currentAnime.Mal_id == -1) NavigateToIndex();

<div Style="padding: 2;">
<PageTitle>AnimeView</PageTitle>


<SearchBar></SearchBar>

    <RadzenButton id="relation-button" Click="NavigateToRelationsPage" Text="RELATIONAL ANIMES" Style="background-image: linear-gradient(to right, #5832dd,#5025ce,#5832dd,#5025ce,#5832dd);"></RadzenButton>
    <RadzenButton id="relation-button" Click="NavigateToMALAnime" Text="MAL LINK" Style="background-image: linear-gradient(to right, #5832dd,#5025ce,#5832dd,#5025ce,#5832dd);"></RadzenButton>
<RadzenRow Style="height:500px; flex:auto; margin-bottom:20px;">
        <RadzenImage Style="display: block; max-width: 300px; max-height: 500px; height:auto; width:auto;" Path="@currentAnime.Image_large_webp_url"></RadzenImage>
        <RadzenColumn Style="min-width:300px; max-width:20vh; margin-left:20px;">
            <div class="rowDiv"><span class="titleSpan">Name(s):</span><br />@TruncateTitles(currentAnime.Title_english, 70)<br /><hr />@TruncateTitles(currentAnime.Title_japanese, 50) </div>
            <div class="rowDiv"><span class="titleSpan">Episodes:</span><br />@currentAnime.Episodes</div>
            <div class="rowDiv"><span class="titleSpan">Type:</span><br />@currentAnime.Media_type</div>
        </RadzenColumn>
         <RadzenColumn Style="min-width:200px; max-width:20vh;">
            <div class="rowDiv"><span class="titleSpan">Score:</span><br />@currentAnime.Score</div>
            <div class="rowDiv"><span class="titleSpan">Airing:</span><br />@currentAnime.Status</div>
            <div class="rowDiv"><span class="titleSpan">Aired:</span><br />@currentAnime.Aired_string</div>
         </RadzenColumn>
        <RadzenColumn Style="min-width:200px; max-width:20vh;">
            <div class="rowDiv"><span class="titleSpan">Popularity:</span><br />@currentAnime.Popularity</div>
            <div class="rowDiv"><span class="titleSpan">Genres:</span><br />@string.Join(",\n", currentAnime.Genres.Select(g => g.Name))</div>
            <div class="rowDiv"><span class="titleSpan">Themes:</span><br />@string.Join(",\n", currentAnime.Themes.Select(g => g.Name))</div>
        </RadzenColumn>
        <RadzenColumn Style="min-width:300px; max-width:20vh;">
            <Div Style="height:33%; min-width:100px; padding-top:20px; margin-left:10px; padding-right:10px;">
                <span class="titleSpan">Producers:</span>:
                   <br />
                        @foreach (var prod in currentAnime.Producers)
                    {
                        <span class="prodentSpan" @onclick="(args) => NavigateToProdEnt(prod.Mal_id)">@prod.Name, </span>
                    }
                </Div>
            <Div Style="height:33%; min-width:100px; padding-top:20px; margin-left:10px; padding-right:10px;">
                <span class="titleSpan">Licensor:</span>:
                    <br />
                    @foreach (var lic in currentAnime.Licensors)
                {
                    <span class="prodentSpan" @onclick="(args) => NavigateToProdEnt(lic.Mal_id)">@lic.Name, </span>
                }</Div>
            <Div Style="height:33%; min-width:100px; padding-top:20px; margin-left:10px; padding-right:10px;">
                <span class="titleSpan">Studios:</span>:
                <br />
                @foreach (var studio in currentAnime.Studios)
                {
                    <span class="prodentSpan" @onclick="(args) => NavigateToProdEnt(studio.Mal_id)">@studio.Name, </span>
                } </Div>
            </RadzenColumn>

    </RadzenRow>
 
   
    <div class="synopsisHeaderDiv titleSpan">
        Synopsis:
        <hr />
    <div class="synopsisDiv">
        @currentAnime.Synopsis
    </div>
    <hr />
 </div>


</div>
@code{
    [Parameter]
    public int mal_id { get; set; }
    Anime currentAnime;
    IList<Anime> relational_animes;

    protected override async Task OnInitializedAsync()
    {

        getCurrentAnime();
        if (currentAnime.Mal_id == -1) return;
        getRelationalAnimes(currentAnime);
        base.OnInitialized();
    }

    protected async Task getCurrentAnime()
    {
        currentAnime = await animeService.GetAnimeByID(mal_id);

    }

    private string TruncateTitles(string title, int title_length)
    {
        if (title.Length <= title_length) return title;
        return title.Substring(0, title_length - 3) + "...";
    }

    protected void NavigateToIndex()
    {
        navManager.NavigateTo("./");
    }

    protected void NavigateToProdEnt(int prodent_id)
    {
        navManager.NavigateTo($"./studio/{prodent_id}");
    }

    protected void NavigateToMALAnime()
    {
        navManager.NavigateTo($"https://myanimelist.net/anime/{mal_id}");
    }


    protected void NavigateToRelationsPage()
    {
        navManager.NavigateTo($"/anime/{mal_id}/relations", forceLoad: true);
    }

    protected async Task getRelationalAnimes(Anime anime)
    {
        relational_animes = await animeService.GetRelations(anime);
    }

  


}